#!/usr/bin/env bash
set -euo pipefail

if [[ $# -lt 1 ]]; then
  LOCATION="${OPENCLAW_CITY:-Abu Dhabi}"
else
  LOCATION="$*"
fi

ENCODED="${LOCATION// /+}"
WTTR_URL="wttr.in/${ENCODED}?format=%l:+%c+%t+%h+%w"
WTTR_OUT="$(curl -sS --max-time 10 "$WTTR_URL" 2>/dev/null || true)"

if [[ -n "$WTTR_OUT" ]]; then
  echo "$WTTR_OUT"
  exit 0
fi

# Fallback: Open-Meteo geocoding + current weather.
python3 - "$LOCATION" <<'PY'
import json
import sys
import urllib.parse
import urllib.request

location = sys.argv[1].strip() or "Abu Dhabi"
q = urllib.parse.quote(location)

geo_url = f"https://geocoding-api.open-meteo.com/v1/search?name={q}&count=1&language=en&format=json"
with urllib.request.urlopen(geo_url, timeout=10) as resp:
    geo = json.load(resp)

results = geo.get("results") or []
if not results:
    raise SystemExit(f"{location}: weather unavailable")

r = results[0]
lat = r.get("latitude")
lon = r.get("longitude")
name = r.get("name") or location

wx_url = (
    "https://api.open-meteo.com/v1/forecast"
    f"?latitude={lat}&longitude={lon}&current_weather=true"
)
with urllib.request.urlopen(wx_url, timeout=10) as resp:
    wx = json.load(resp)

cw = wx.get("current_weather") or {}
temp = cw.get("temperature")
wind = cw.get("windspeed")
code = cw.get("weathercode")
print(f"{name}: {temp}C wind {wind}km/h code {code}")
PY

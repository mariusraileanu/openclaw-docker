#cloud-config
package_update: true
package_upgrade: true

packages:
  - ca-certificates
  - curl
  - git
  - jq

write_files:
  - path: /usr/local/bin/bootstrap-openclaw.sh
    permissions: "0755"
    owner: root:root
    content: |
      #!/usr/bin/env bash
      set -euo pipefail

      REPO_URL="${REPO_URL:-https://github.com/REPLACE_ME/openclaw-docker.git}"
      REPO_DIR="${REPO_DIR:-/opt/openclaw-docker}"

      if ! command -v docker >/dev/null 2>&1; then
        curl -fsSL https://get.docker.com | sh
        usermod -aG docker azureuser || true
      fi

      mkdir -p "$REPO_DIR"
      if [[ ! -d "$REPO_DIR/.git" ]]; then
        git clone "$REPO_URL" "$REPO_DIR"
      else
        git -C "$REPO_DIR" pull --ff-only
      fi

      cd "$REPO_DIR"
      [[ -f .env ]] || cp .env.example .env
      chown azureuser:azureuser .env || true
      chmod 600 .env || true
      [[ -f data/.openclaw/openclaw.json ]] || bin/openclawctl init

      cat >/etc/systemd/system/openclaw-compose.service <<'EOF'
      [Unit]
      Description=OpenClaw Docker Compose
      After=docker.service network-online.target
      Requires=docker.service

      [Service]
      Type=oneshot
      WorkingDirectory=/opt/openclaw-docker
      RemainAfterExit=yes
      ExecStart=/usr/bin/docker compose up -d
      ExecStop=/usr/bin/docker compose down
      TimeoutStartSec=0

      [Install]
      WantedBy=multi-user.target
      EOF

      systemctl daemon-reload
      systemctl enable openclaw-compose.service

      echo ""
      echo "Bootstrap complete."
      echo "Next steps:"
      echo "1) Edit $REPO_DIR/.env with real secrets."
      echo "2) Run: cd $REPO_DIR && docker compose build"
      echo "3) Run: cd $REPO_DIR && bin/openclawctl provision"

runcmd:
  - [ bash, -lc, "/usr/local/bin/bootstrap-openclaw.sh" ]

final_message: "OpenClaw cloud-init bootstrap finished. Configure /opt/openclaw-docker/.env then run build + provision."
